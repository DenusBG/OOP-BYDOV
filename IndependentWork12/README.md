# üìë –ó–≤—ñ—Ç –ø—Ä–æ –°–∞–º–æ—Å—Ç—ñ–π–Ω—É –†–æ–±–æ—Ç—É ‚Ññ12: PLINQ (Parallel LINQ)

### –¢–µ–º–∞: PLINQ: –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ç–∞ –±–µ–∑–ø–µ–∫–∏.
### –ú–µ—Ç–∞: –î–æ—Å–ª—ñ–¥–∏—Ç–∏ –ø–µ—Ä–µ–≤–∞–≥–∏ PLINQ, –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ –π–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑—ñ –∑–≤–∏—á–∞–π–Ω–∏–º LINQ —Ç–∞ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏ –ø–æ—Ç–æ–∫–æ–±–µ–∑–ø–µ—á–Ω–æ—Å—Ç—ñ –ø—Ä–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ–π –æ–±—Ä–æ–±—Ü—ñ.

---

## üöÄ –ó–∞–≥–∞–ª—å–Ω—ñ –í–∏—Å–Ω–æ–≤–∫–∏ —â–æ–¥–æ PLINQ

**PLINQ (Parallel LINQ)** ‚Äî —Ü–µ –ø–æ—Ç—É–∂–Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—è, —è–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–∞—Ä–∞–ª–µ–ª—ñ–∑—É—î –∑–∞–ø–∏—Ç–∏ LINQ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–µ—Ä–µ–≤–∞–≥–∏ –±–∞–≥–∞—Ç–æ—è–¥–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤. –ô–æ–≥–æ –æ—Å–Ω–æ–≤–Ω–∞ –ø–µ—Ä–µ–≤–∞–≥–∞ ‚Äî –∑–Ω–∞—á–Ω–µ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–±—á–∏—Å–ª—é–≤–∞–ª—å–Ω–æ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –Ω–∞ –≤–µ–ª–∏–∫–∏—Ö –æ–±—Å—è–≥–∞—Ö –¥–∞–Ω–∏—Ö. –ü—Ä–æ—Ç–µ, PLINQ –≤–∏–º–∞–≥–∞—î —É–≤–∞–≥–∏ –¥–æ **–ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤** —ñ **—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó** —Å–ø—ñ–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É.

---

## 1. –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (LINQ vs PLINQ)

### ‚öôÔ∏è –û–±—á–∏—Å–ª—é–≤–∞–ª—å–Ω–∞ –û–ø–µ—Ä–∞—Ü—ñ—è —Ç–∞ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
* **–û–ø–µ—Ä–∞—Ü—ñ—è:** –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—Å—Ç–µ —á–∏—Å–ª–æ (`IsPrime`). –¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è —î **–æ–±—á–∏—Å–ª—é–≤–∞–ª—å–Ω–æ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—é**, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∏–º–∞–≥–∞—î –±–∞–≥–∞—Ç–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∏—Ö —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞.
* **–†–æ–∑–º—ñ—Ä –ö–æ–ª–µ–∫—Ü—ñ—ó:** 5,000,000 —Ü—ñ–ª–∏—Ö —á–∏—Å–µ–ª.
* **–ú–µ—Ç–æ–¥:** `System.Diagnostics.Stopwatch` –¥–ª—è –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —á–∞—Å—É.

### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è (–ü—Ä–∏–∫–ª–∞–¥)

| –û–±—Å—è–≥ –î–∞–Ω–∏—Ö | –û–±—á–∏—Å–ª—é–≤–∞–ª—å–Ω–∞ –û–ø–µ—Ä–∞—Ü—ñ—è | LINQ (–ü–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π) | PLINQ (–ü–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π) | –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è (–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç) |
| :--- | :--- | :--- | :--- | :--- |
| **5,000,000** | –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ü—Ä–æ—Å—Ç–µ –ß–∏—Å–ª–æ | ~27,000 –º—Å | ~6,500 –º—Å | **~4.1x** |

*(–ü—Ä–∏–º—ñ—Ç–∫–∞: –§–∞–∫—Ç–∏—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–∂—É—Ç—å –≤–∞—Ä—ñ—é–≤–∞—Ç–∏—Å—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —è–¥–µ—Ä –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞, –∞–ª–µ —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è)*

### üìù –ê–Ω–∞–ª—ñ–∑
1.  **–ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è:** –ù–∞—à–∞ –æ–±—á–∏—Å–ª—é–≤–∞–ª—å–Ω–æ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è –¥–∞–ª–∞ **–ø–æ–Ω–∞–¥ —á–æ—Ç–∏—Ä–∏–∫—Ä–∞—Ç–Ω–µ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è** –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥—ñ –≤—ñ–¥ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ LINQ –¥–æ PLINQ (`.AsParallel()`).
2.  **–î–æ—Ü—ñ–ª—å–Ω—ñ—Å—Ç—å PLINQ:** PLINQ –¥–æ—Ü—ñ–ª—å–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–∞–º–µ –¥–ª—è —Ç–∞–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ ‚Äî –≤–µ–ª–∏–∫–∞ –∫–æ–ª–µ–∫—Ü—ñ—è —Ç–∞ —Å–∫–ª–∞–¥–Ω–∞, —Ä–µ—Å—É—Ä—Å–æ–∑–∞—Ç—Ä–∞—Ç–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∫–æ–∂–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞. –£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É, –≤–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–æ—Ç–æ–∫–∞–º–∏ (threading overhead) –∑–Ω–∞—á–Ω–æ –º–µ–Ω—à—ñ, –Ω—ñ–∂ –≤–∏–≥–æ–¥–∞ –≤—ñ–¥ –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–∞—Ü—ñ—ó.

---

## 2. –î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –ü–æ–±—ñ—á–Ω–∏—Ö –ï—Ñ–µ–∫—Ç—ñ–≤ —Ç–∞ –ë–µ–∑–ø–µ–∫–∏

### üö® –ü—Ä–æ–±–ª–µ–º–∞: –ì–æ–Ω–∫–∞ –î–∞–Ω–∏—Ö (Race Condition)
* **–°—Ü–µ–Ω–∞—Ä—ñ–π:** –°–ø—Ä–æ–±–∞ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É–≤–∞—Ç–∏ —Å–ø—ñ–ª—å–Ω—É –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É (`globalCounter`) –∑—Å–µ—Ä–µ–¥–∏–Ω–∏ –ª—è–º–±–¥–∞-–≤–∏—Ä–∞–∑—É PLINQ.
* **–°—É—Ç—å –ü—Ä–æ–±–ª–µ–º–∏:** –û–ø–µ—Ä–∞—Ü—ñ—è —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É (`++`) —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —Ç—Ä—å–æ—Ö –Ω–µ–∞—Ç–æ–º–∞—Ä–Ω–∏—Ö –∫—Ä–æ–∫—ñ–≤ (—á–∏—Ç–∞–Ω–Ω—è, –∑–º—ñ–Ω–∞, –∑–∞–ø–∏—Å). –ö–æ–ª–∏ –∫—ñ–ª—å–∫–∞ –ø–æ—Ç–æ–∫—ñ–≤ –≤–∏–∫–æ–Ω—É—é—Ç—å —Ü—ñ –∫—Ä–æ–∫–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ, –≤–æ–Ω–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—é—Ç—å —Ä–æ–±–æ—Ç—É –æ–¥–∏–Ω –æ–¥–Ω–æ–≥–æ, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ **–≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö** —Ç–∞ **–Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É**.

| –°—Ü–µ–Ω–∞—Ä—ñ–π | –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (1M) | –§–∞–∫—Ç–∏—á–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–ü—Ä–∏–∫–ª–∞–¥) | –í–∏—Å–Ω–æ–≤–æ–∫ |
| :--- | :--- | :--- | :--- |
| **–ù–µ–±–µ–∑–ø–µ—á–Ω–∏–π PLINQ** (–±–µ–∑ `lock`) | 1,000,000 | ~987,500 | **–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç** —á–µ—Ä–µ–∑ –≥–æ–Ω–∫—É –¥–∞–Ω–∏—Ö. |

### ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è (`lock`)

* **–†—ñ—à–µ–Ω–Ω—è:** –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ **`lock(lockObject)`** –Ω–∞–≤–∫–æ–ª–æ –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –±–ª–æ–∫—É –∫–æ–¥—É, —è–∫–∏–π –º–æ–¥–∏—Ñ—ñ–∫—É—î —Å–ø—ñ–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É.
* **–ú–µ—Ö–∞–Ω—ñ–∑–º:** `lock` –∑–∞–±–µ–∑–ø–µ—á—É—î **–µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø** –¥–æ —Ä–µ—Å—É—Ä—Å—É, –≥–∞—Ä–∞–Ω—Ç—É—é—á–∏, —â–æ –ª–∏—à–µ –æ–¥–∏–Ω –ø–æ—Ç—ñ–∫ –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç —É —Ü–µ–π –º–æ–º–µ–Ω—Ç —á–∞—Å—É, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –æ–ø–µ—Ä–∞—Ü—ñ—è –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ.

### –§—Ä–∞–≥–º–µ–Ω—Ç –ö–æ–¥—É (–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è):

```csharp
data.AsParallel()
    .ForAll(item => 
    {
        // lock –≥–∞—Ä–∞–Ω—Ç—É—î –ø–æ—Ç–æ–∫–æ–±–µ–∑–ø–µ–∫—É
        lock (lockObject) 
        {
            globalCounter++;
        }
    });
// –†–µ–∑—É–ª—å—Ç–∞—Ç: –§–∞–∫—Ç–∏—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è = 1,000,000 (–ö–æ—Ä–µ–∫—Ç–Ω–æ)